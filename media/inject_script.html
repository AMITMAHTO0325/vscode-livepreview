<!-- Script injected by VS Live Server -->
<script type="text/javascript" defer>
	const url = 'ws://localhost:${WS_PORTNUM}';
	const connection = new WebSocket(url);

	connection.onerror = (error) => {
		console.log('WebSocket error: ');
		console.log(error);
	};

	connection.onmessage = (event) => handleSocketMessage(event.data);

	window.addEventListener(
		'message',
		(event) => handleMessage(event),
		false
	);

	document.addEventListener('DOMContentLoaded', function (e) {
		onLoad()
	});

	window.addEventListener('message', (event) => {
		if (event.data.command == 'open-external-link') {
			window.parent.postMessage(event.data, '*');
		}
	});

	function handleSocketMessage(data) {
		const parsedMessage = JSON.parse(data);
		switch (parsedMessage.command) {
			case 'reload': {
				window.location.reload();
			}
		}
	}

	function handleMessage(event) {
		if (event.data == 'refresh') {
				window.location.reload();
			} else if (event.data == 'setup-parent-listener') {
				commandPayload = {
					pathname: window.location.pathname,
					fullPath: window.location,
					title: document.title,
				};
				window.parent.postMessage(
					{
						command: 'update-path',
						text: JSON.stringify(commandPayload),
					},
					'*'
				);
			}
	}
	
	function onLoad() {
		commandPayload = {
			pathname: window.location.pathname,
			fullPath: window.location,
			title: document.title,
		};
		window.parent.postMessage(
			{ command: 'update-path', text: JSON.stringify(commandPayload) },
			'*'
		);

		var l = document.getElementsByTagName('a');
		for (var i = 0; i < l.length; i++) {
			l[i].onclick = (e) => {
				handleLink(e.target.href)
			};
		}
	}

	function handleLink(linkTarget) {
		if (linkTarget != '') {
			if (!linkTarget.startsWith('http://127.0.0.1:')) {
				window.parent.postMessage(
					{ command: 'open-external-link', text: linkTarget },
					'*'
				);
			} else {
				// check all local URLs to make sure to catch pages that won't be injectable
				window.parent.postMessage(
					{ command: 'perform-url-check', text: linkTarget },
					'*'
				);
			}
		}
	}
</script>
