<!-- Script injected by VS Live Preview -->
<script type="text/javascript">
	const url = '${WS_URL}';
	const host = '${HTTP_URL}';
	const connection = new WebSocket(url);

	connection.onerror = (error) => {
		console.log('WebSocket error: ');
		console.log(error);
	};

	connection.onclose = (event) => {
		console.log('Error occurred.');
		console.log(event);
	};

	connection.onmessage = (event) => handleSocketMessage(event.data);

	window.addEventListener('message', (event) => handleMessage(event), false);

	document.addEventListener('DOMContentLoaded', function (e) {
		onLoad();
	});

	window.addEventListener('message', (event) => {
		if (
			event.data.command != 'perform-url-check' &&
			event.data.command != 'update-path'
		) {
			postParentMessage(event.data);
		}
	});

	var _log = console.log;
	var _error = console.error;
	var _warning = console.warn;
	var _info = console.info;

	console.error = function(errMessage){
		var messagePayload = {
			type: 'error',
			data: errMessage
		}
		postParentMessage({command:'error',text:JSON.stringify(messagePayload)});
		_error.apply(console,arguments);
	};

	console.log = function(logMessage){
		var messagePayload = {
			type: 'log',
			data: logMessage
		}
		postParentMessage({command:'log',text:JSON.stringify(messagePayload)});
		_log.apply(console,arguments);
	};

	console.warn = function(warnMessage){
		// do something with the warn message
		var messagePayload = {
			type: 'warning',
			data: warnMessage
		}
		postParentMessage({command:'log',text:JSON.stringify(messagePayload)});
		_warning.apply(console,arguments);
	};

	console.info = function(infoMessage){
		// do something with the warn message
		var messagePayload = {
			type: 'info',
			data: infoMessage
		}
		postParentMessage({command:'log',text:JSON.stringify(messagePayload)});
		_info.apply(console,arguments);
	};

	function handleSocketMessage(data) {
		const parsedMessage = JSON.parse(data);
		switch (parsedMessage.command) {
			case 'reload': {
				window.location.reload();
			}
		}
	}

	function handleMessage(event) {
		if (event.data == 'refresh') {
			window.location.reload();
		} else if (event.data == 'setup-parent-listener') {
			commandPayload = {
				path: window.location,
				title: document.title,
			};

			postParentMessage({
				command: 'update-path',
				text: JSON.stringify(commandPayload),
			});
		}
	}

	function onLoad() {
		commandPayload = {
			path: window.location,
			title: document.title,
		};
		postParentMessage({
			command: 'update-path',
			text: JSON.stringify(commandPayload),
		});
		handleLinkHoverEnd();

		var l = document.getElementsByTagName('a');
		for (var i = 0; i < l.length; i++) {
			l[i].onclick = (e) => handleLinkClick(e.target.href);
			l[i].onmouseenter = (e) => handleLinkHoverStart(e.target.href);
			l[i].onmouseleave = (e) => handleLinkHoverEnd();
		}
	}

	function postParentMessage(data) {
		if (window.parent !== window) {
			window.parent.postMessage(data, '*');
		}
	}
	function handleLinkClick(linkTarget) {
		if (linkTarget && linkTarget != '') {
			if (!linkTarget.startsWith(host)) {
				postParentMessage({ command: 'open-external-link', text: linkTarget });
			} else {
				// check all local URLs to make sure to catch pages that won't be injectable
				postParentMessage({ command: 'perform-url-check', text: linkTarget });
			}
		}
	}

	function handleLinkHoverStart(linkTarget) {
		postParentMessage({
			command: 'link-hover-start',
			text: linkTarget,
		});
	}

	function handleLinkHoverEnd() {
		postParentMessage({
			command: 'link-hover-end',
		});
	}
</script>
